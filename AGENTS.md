# AGENTS.md — Repository Automation Policy (Generic)

## 目的
このリポジトリは、LLM（GPT-5-Codex など）を用いた「自動コーディング／自動修復」を前提に運用します。  
サービス固有の仕様は **SPEC.md** に集約し、ここではリポ横断の運用・品質・セキュリティ基準を定義します。

## 運用モード
- **auto-commit（小変更向け・推奨）**: Lint/型/テストにのみ影響、差分が小さい修正は自動コミット→PR→自動マージ可。
- **staged-automation（中規模）**: ロジック変更や依存軽微追加。CodexがPR作成、要人承認。
- **manual（重要）**: APIスキーマ変更、依存大幅更新、セキュリティ影響は人がレビュー＆承認。自動マージ不可。

## コマンド標準（package.json の scripts に合わせること）
- **依存**: `pnpm install`
- **Lint**: `pnpm lint`
- **型**: `pnpm typecheck`
- **テスト**: `pnpm test`
- **開発**: `pnpm dev`
- **ビルド**: `pnpm build`
> これらは Codex/CI が自動で実行します。名称変更時は本書を更新。

## テスト方針
- すべての変更は `lint` `typecheck` `test` を **green** にしてからコミット。
- 外部API呼び出しは **モック** を既定（ネットワーク非依存）。
- 不具合修正PRは **再発防止テスト** を追加。

## コードスタイル
- TypeScript strict、有効なESLint/Prettier設定を遵守（未使用・暗黙any禁止、import順序固定）。

## CIルール
- `main` 直コミット禁止。**PR必須**。
- CI（`.github/workflows/ci.yml`）は **lint→type→test** を実行。
- 失敗時は **codex-autofix** が最大3回まで自動修復PRを作成。

## 自動修復ポリシー
- 目的：CI失敗の自己修復（フォーマット、型ミス、足りないテスト等）。
- 原則：**最小差分**、既存設計の尊重、過剰リファクタ禁止。
- 3回連続失敗時は **フォールバック**（PRに原因分析ノートを残す）。

## 承認とスコープ基準
- **小変更**（<100行、テスト/スタイル調整のみ）: 自動マージ可
- **中規模**（100–500行、ロジック変更/軽微依存追加）: レビュー1名以上
- **重要**（>500行、API/DBスキーマ/セキュリティ）: レビュー2名以上、手動マージ

## ネットワークと権限
- Secrets（APIキー等）は **GitHub Secrets** のみ使用。平文コミット禁止。
- Codex の外部ネットワークは **必要時のみ** 許可（依存調査等）。不要時はローカル情報で完結。

## SPEC.md との関係
- **AGENTS.md**: 横断的な運用・品質規約
- **SPEC.md**: 各サービス固有の仕様（要件、API入出力、UI/UX、例外系など）
- Codex は **まず SPEC.md → 次に本書** の順で解釈すること。

## 変更時の責務
- 仕様やスクリプトを変更したら **AGENTS.md / SPEC.md / CI** を同期更新。
- 大きな構造変更は「設計意図・影響範囲・移行手順」を PR に明記。

## 既知の実行順序（Codex への指示例）
1) 変更影響度の推定（小/中/重要）  
2) `pnpm install` → `lint` → `typecheck` → `test` を**ローカル検証**  
3) 失敗時は最小差分で自己修復（最大3回）  
4) 成功なら影響度に応じてPR/マージ方針を自動選択  
5) 重要変更は人の承認待ち
